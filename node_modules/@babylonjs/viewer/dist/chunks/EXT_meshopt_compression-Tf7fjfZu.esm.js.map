{"version":3,"file":"EXT_meshopt_compression-Tf7fjfZu.esm.js","sources":["../../../../../dev/core/dist/Meshes/Compression/meshoptCompression.js","../../../../../dev/loaders/dist/glTF/2.0/Extensions/EXT_meshopt_compression.js"],"sourcesContent":["import { Tools } from \"../../Misc/tools\";\n// eslint-disable-next-line @typescript-eslint/naming-convention\nlet NumberOfWorkers = 0;\n// eslint-disable-next-line @typescript-eslint/naming-convention\nlet WorkerTimeout = null;\n/**\n * Meshopt compression (https://github.com/zeux/meshoptimizer)\n *\n * This class wraps the meshopt library from https://github.com/zeux/meshoptimizer/tree/master/js.\n *\n * **Encoder**\n *\n * The encoder is not currently implemented.\n *\n * **Decoder**\n *\n * By default, the configuration points to a copy of the meshopt files on the Babylon.js preview CDN (e.g. https://preview.babylonjs.com/meshopt_decoder.js).\n *\n * To update the configuration, use the following code:\n * ```javascript\n *     MeshoptCompression.Configuration = {\n *         decoder: {\n *             url: \"<url to the meshopt decoder library>\"\n *         }\n *     };\n * ```\n */\nexport class MeshoptCompression {\n    /**\n     * Default instance for the meshoptimizer object.\n     */\n    static get Default() {\n        if (!MeshoptCompression._Default) {\n            MeshoptCompression._Default = new MeshoptCompression();\n        }\n        return MeshoptCompression._Default;\n    }\n    /**\n     * Constructor\n     */\n    constructor() {\n        const decoder = MeshoptCompression.Configuration.decoder;\n        // eslint-disable-next-line github/no-then\n        this._decoderModulePromise = Tools.LoadBabylonScriptAsync(decoder.url).then(() => {\n            // Wait for WebAssembly compilation before resolving promise\n            return MeshoptDecoder.ready;\n        });\n    }\n    /**\n     * Stop all async operations and release resources.\n     */\n    dispose() {\n        delete this._decoderModulePromise;\n    }\n    /**\n     * Decode meshopt data.\n     * @see https://github.com/zeux/meshoptimizer/tree/master/js#decoder\n     * @param source The input data.\n     * @param count The number of elements.\n     * @param stride The stride in bytes.\n     * @param mode The compression mode.\n     * @param filter The compression filter.\n     * @returns a Promise<Uint8Array> that resolves to the decoded data\n     */\n    async decodeGltfBufferAsync(source, count, stride, mode, filter) {\n        await this._decoderModulePromise;\n        if (NumberOfWorkers === 0) {\n            MeshoptDecoder.useWorkers(1);\n            NumberOfWorkers = 1;\n        }\n        const result = await MeshoptDecoder.decodeGltfBufferAsync(count, stride, source, mode, filter);\n        // a simple debounce to avoid switching back and forth between workers and no workers while decoding\n        if (WorkerTimeout !== null) {\n            clearTimeout(WorkerTimeout);\n        }\n        WorkerTimeout = setTimeout(() => {\n            MeshoptDecoder.useWorkers(0);\n            NumberOfWorkers = 0;\n            WorkerTimeout = null;\n        }, 1000);\n        return result;\n    }\n}\n/**\n * The configuration. Defaults to the following:\n * ```javascript\n * decoder: {\n *   url: \"https://cdn.babylonjs.com/meshopt_decoder.js\"\n * }\n * ```\n */\nMeshoptCompression.Configuration = {\n    decoder: {\n        url: `${Tools._DefaultCdnUrl}/meshopt_decoder.js`,\n    },\n};\nMeshoptCompression._Default = null;\n//# sourceMappingURL=meshoptCompression.js.map","import { ArrayItem, GLTFLoader } from \"../glTFLoader\";\nimport { MeshoptCompression } from \"core/Meshes/Compression/meshoptCompression\";\nimport { registerGLTFExtension, unregisterGLTFExtension } from \"../glTFLoaderExtensionRegistry\";\nconst NAME = \"EXT_meshopt_compression\";\n/**\n * [Specification](https://github.com/KhronosGroup/glTF/blob/main/extensions/2.0/Vendor/EXT_meshopt_compression/README.md)\n *\n * This extension uses a WebAssembly decoder module from https://github.com/zeux/meshoptimizer/tree/master/js\n * @since 5.0.0\n */\n// eslint-disable-next-line @typescript-eslint/naming-convention\nexport class EXT_meshopt_compression {\n    /**\n     * @internal\n     */\n    constructor(loader) {\n        /**\n         * The name of this extension.\n         */\n        this.name = NAME;\n        this.enabled = loader.isExtensionUsed(NAME);\n        this._loader = loader;\n    }\n    /** @internal */\n    dispose() {\n        this._loader = null;\n    }\n    /**\n     * @internal\n     */\n    // eslint-disable-next-line no-restricted-syntax\n    loadBufferViewAsync(context, bufferView) {\n        return GLTFLoader.LoadExtensionAsync(context, bufferView, this.name, async (extensionContext, extension) => {\n            const bufferViewMeshopt = bufferView;\n            if (bufferViewMeshopt._meshOptData) {\n                return await bufferViewMeshopt._meshOptData;\n            }\n            const buffer = ArrayItem.Get(`${context}/buffer`, this._loader.gltf.buffers, extension.buffer);\n            bufferViewMeshopt._meshOptData = this._loader\n                .loadBufferAsync(`/buffers/${buffer.index}`, buffer, extension.byteOffset || 0, extension.byteLength)\n                // eslint-disable-next-line github/no-then\n                .then(async (buffer) => {\n                return await MeshoptCompression.Default.decodeGltfBufferAsync(buffer, extension.count, extension.byteStride, extension.mode, extension.filter);\n            });\n            return await bufferViewMeshopt._meshOptData;\n        });\n    }\n}\nunregisterGLTFExtension(NAME);\nregisterGLTFExtension(NAME, true, (loader) => new EXT_meshopt_compression(loader));\n//# sourceMappingURL=EXT_meshopt_compression.js.map"],"names":[],"mappings":"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"}