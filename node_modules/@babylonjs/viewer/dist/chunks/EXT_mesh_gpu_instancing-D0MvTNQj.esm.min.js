import{d as e,b as t,Q as s,p as o,L as r,bL as n,bK as a}from"./index-1dDxZ_0d.esm.min.js";import{GLTFLoader as i,ArrayItem as c}from"./glTFLoader-wHGixHtC.esm.min.js";import"./thinInstanceMesh-B7hElm4C.esm.min.js";import"./bone-rpjVhoW9.esm.min.js";import"./skeleton-BuLyjIk1.esm.min.js";import"./rawTexture-DNIIHHuO.esm.min.js";import"./assetContainer-Dam1dL5M.esm.min.js";import"./objectModelMapping-DtrR_R-D.esm.min.js";const m="EXT_mesh_gpu_instancing";class l{constructor(e){this.name=m,this._loader=e,this.enabled=this._loader.isExtensionUsed(m)}dispose(){this._loader=null}loadNodeAsync(n,a,m){return i.LoadExtensionAsync(n,a,this.name,(async(n,i)=>{this._loader._disableInstancedMesh++;const l=this._loader.loadNodeAsync(`/nodes/${a.index}`,a,m);if(this._loader._disableInstancedMesh--,!a._primitiveBabylonMeshes)return await l;const h=new Array;let d=0;const u=e=>{if(null==i.attributes[e])return void h.push(Promise.resolve(null));const t=c.Get(`${n}/attributes/${e}`,this._loader.gltf.accessors,i.attributes[e]);if(h.push(this._loader._loadFloatAccessorAsync(`/accessors/${t.bufferView}`,t)),0===d)d=t.count;else if(d!==t.count)throw new Error(`${n}/attributes: Instance buffer accessors do not have the same count.`)};return u("TRANSLATION"),u("ROTATION"),u("SCALE"),u("_COLOR_0"),await l.then((async n=>{const[i,c,m,l]=await Promise.all(h),u=new Float32Array(16*d);e.Vector3[0].copyFromFloats(0,0,0),e.Quaternion[0].copyFromFloats(0,0,0,1),e.Vector3[1].copyFromFloats(1,1,1);for(let r=0;r<d;++r)i&&t.FromArrayToRef(i,3*r,e.Vector3[0]),c&&s.FromArrayToRef(c,4*r,e.Quaternion[0]),m&&t.FromArrayToRef(m,3*r,e.Vector3[1]),o.ComposeToRef(e.Vector3[1],e.Quaternion[0],e.Vector3[0],e.Matrix[0]),e.Matrix[0].copyToArray(u,16*r);for(const e of a._primitiveBabylonMeshes)e.thinInstanceSetBuffer("matrix",u,16,!0),l&&(l.length===3*d?e.thinInstanceSetBuffer("color",l,3,!0):l.length===4*d?e.thinInstanceSetBuffer("color",l,4,!0):r.Warn("Unexpected size of _COLOR_0 attribute for mesh "+e.name));return n}))}))}}n(m),a(m,!0,(e=>new l(e)));export{l as EXT_mesh_gpu_instancing};
//# sourceMappingURL=EXT_mesh_gpu_instancing-D0MvTNQj.esm.min.js.map
