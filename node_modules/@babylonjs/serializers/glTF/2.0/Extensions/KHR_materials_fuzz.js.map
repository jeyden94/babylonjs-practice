{"version":3,"file":"KHR_materials_fuzz.js","sourceRoot":"","sources":["../../../../../../dev/serializers/src/glTF/2.0/Extensions/KHR_materials_fuzz.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IMaterial, IKHRMaterialsFuzz } from \"babylonjs-gltf2interface\";\r\nimport type { IGLTFExporterExtensionV2 } from \"../glTFExporterExtension\";\r\nimport { GLTFExporter } from \"../glTFExporter\";\r\nimport type { Material } from \"core/Materials/material\";\r\nimport { OpenPBRMaterial } from \"core/Materials/PBR/openpbrMaterial\";\r\nimport { MergeTexturesAsync, CreateRGBAConfiguration, CreateTextureInput, CreateConstantInput } from \"core/Materials/Textures/textureMerger\";\r\nimport type { BaseTexture } from \"core/Materials/Textures/baseTexture\";\r\nimport type { Nullable } from \"core/types\";\r\nimport type { InternalTexture } from \"core/Materials/Textures/internalTexture\";\r\nimport { Texture } from \"core/Materials/Textures/texture\";\r\n\r\nconst NAME = \"KHR_materials_fuzz\";\r\n\r\n/**\r\n * Generate a unique ID for the merged coat textures based on the internal texture data.\r\n * This is used for caching merged textures.\r\n * @param babylonMaterial Source OpenPBR material\r\n * @returns A unique ID string for the merged coat textures\r\n * @internal\r\n */\r\nfunction GetFuzzColorTextureId(babylonMaterial: OpenPBRMaterial): string {\r\n    const fuzzColorTexture: Nullable<BaseTexture> = babylonMaterial.fuzzColorTexture;\r\n    const fuzzColorId = fuzzColorTexture && fuzzColorTexture.getInternalTexture() ? fuzzColorTexture!.getInternalTexture()!.uniqueId : \"NoFuzzColor\";\r\n    const fuzzRoughnessTexture: Nullable<BaseTexture> = babylonMaterial.fuzzRoughnessTexture;\r\n    const fuzzRoughnessId = fuzzRoughnessTexture && fuzzRoughnessTexture.getInternalTexture() ? fuzzRoughnessTexture!.getInternalTexture()!.uniqueId : \"NoFuzzRoughness\";\r\n    return `FuzzColor_${fuzzColorId}_FuzzRoughness_${fuzzRoughnessId}`;\r\n}\r\n\r\n/**\r\n * Using the coat weight and coat roughness textures, create a merged internal texture that can be used\r\n * for multiple textures (with potentially different transforms) on export.\r\n * @param babylonMaterial The source OpenPBR material\r\n * @returns A new, internal texture with the coat weight in the red channel and coat roughness in the green channel\r\n * @internal\r\n */\r\nasync function CreateMergedFuzzInternalTexture(babylonMaterial: OpenPBRMaterial): Promise<Nullable<InternalTexture>> {\r\n    const scene = babylonMaterial.getScene();\r\n    const fuzzColorTexture: Nullable<BaseTexture> = babylonMaterial.fuzzColorTexture;\r\n    const fuzzRoughnessTexture: Nullable<BaseTexture> = babylonMaterial.fuzzRoughnessTexture;\r\n    // If we don't have any textures, we don't need to generate anything.\r\n    if (!(fuzzColorTexture || fuzzRoughnessTexture)) {\r\n        return null;\r\n    }\r\n\r\n    const texture = await MergeTexturesAsync(\r\n        \"FuzzTexture\",\r\n        CreateRGBAConfiguration(\r\n            fuzzColorTexture ? CreateTextureInput(fuzzColorTexture, 0) : CreateConstantInput(1.0), // fuzz color from red channel\r\n            fuzzColorTexture ? CreateTextureInput(fuzzColorTexture, 1) : CreateConstantInput(1.0), // fuzz color from green channel\r\n            fuzzColorTexture ? CreateTextureInput(fuzzColorTexture, 2) : CreateConstantInput(1.0), // fuzz color from blue channel\r\n            // fuzz roughness goes in the alpha channel but may come from red or alpha channels in the source\r\n            fuzzRoughnessTexture ? CreateTextureInput(fuzzRoughnessTexture, babylonMaterial._useFuzzRoughnessFromTextureAlpha ? 3 : 0) : CreateConstantInput(1.0)\r\n        ),\r\n        scene\r\n    );\r\n\r\n    return texture.getInternalTexture();\r\n}\r\n\r\n/**\r\n * Creates a temporary texture based on the source texture.\r\n * @param internalTexture The source internal texture\r\n * @param sourceTexture The source of the new texture's name, and sampler info\r\n * @returns The new texture\r\n */\r\nfunction CreateTempTexture(internalTexture: InternalTexture, sourceTexture: BaseTexture): Texture {\r\n    const tempTexture = new Texture(sourceTexture.name, sourceTexture.getScene());\r\n    tempTexture._texture = internalTexture;\r\n    tempTexture.coordinatesIndex = sourceTexture.coordinatesIndex;\r\n    if (sourceTexture instanceof Texture) {\r\n        tempTexture.uOffset = sourceTexture.uOffset;\r\n        tempTexture.vOffset = sourceTexture.vOffset;\r\n        tempTexture.uScale = sourceTexture.uScale;\r\n        tempTexture.vScale = sourceTexture.vScale;\r\n        tempTexture.wAng = sourceTexture.wAng;\r\n    }\r\n    tempTexture.wrapU = sourceTexture.wrapU;\r\n    tempTexture.wrapV = sourceTexture.wrapV;\r\n    return tempTexture;\r\n}\r\n\r\n/**\r\n * @internal\r\n */\r\n// eslint-disable-next-line @typescript-eslint/naming-convention\r\nexport class KHR_materials_fuzz implements IGLTFExporterExtensionV2 {\r\n    /** Name of this extension */\r\n    public readonly name = NAME;\r\n\r\n    /** Defines whether this extension is enabled */\r\n    public enabled = true;\r\n\r\n    /** Defines whether this extension is required */\r\n    public required = false;\r\n\r\n    private _wasUsed = false;\r\n\r\n    private _exporter: GLTFExporter;\r\n\r\n    constructor(exporter: GLTFExporter) {\r\n        this._exporter = exporter;\r\n    }\r\n\r\n    /**\r\n     * Cache that holds temporary merged textures created during export\r\n     */\r\n    private _mergedTexturesMap: Record<string, BaseTexture> = {};\r\n\r\n    /**\r\n     * Cache that holds internal textures of merged textures created during export\r\n     */\r\n    private _cachedInternalTexturesMap: Record<string, InternalTexture> = {};\r\n\r\n    public dispose() {\r\n        for (const key of Object.keys(this._mergedTexturesMap)) {\r\n            const texture = this._mergedTexturesMap[key];\r\n            texture.dispose();\r\n        }\r\n        this._mergedTexturesMap = {};\r\n        for (const key of Object.keys(this._cachedInternalTexturesMap)) {\r\n            const internalTexture = this._cachedInternalTexturesMap[key];\r\n            internalTexture.dispose();\r\n        }\r\n        this._cachedInternalTexturesMap = {};\r\n    }\r\n\r\n    /** @internal */\r\n    public get wasUsed() {\r\n        return this._wasUsed;\r\n    }\r\n\r\n    public async postExportMaterialAdditionalTexturesAsync(context: string, node: IMaterial, babylonMaterial: Material): Promise<BaseTexture[]> {\r\n        if (babylonMaterial instanceof OpenPBRMaterial) {\r\n            const additionalTextures: BaseTexture[] = [];\r\n            if (babylonMaterial.fuzzWeight > 0.0) {\r\n                if (babylonMaterial.fuzzWeightTexture) {\r\n                    additionalTextures.push(babylonMaterial.fuzzWeightTexture);\r\n                }\r\n                let fuzzTexturesNeedMerge = false;\r\n                if (babylonMaterial.fuzzRoughnessTexture) {\r\n                    if (babylonMaterial._useFuzzRoughnessFromTextureAlpha) {\r\n                        additionalTextures.push(babylonMaterial.fuzzRoughnessTexture);\r\n                    } else {\r\n                        fuzzTexturesNeedMerge = true;\r\n                    }\r\n                }\r\n                if (babylonMaterial.fuzzColorTexture && !fuzzTexturesNeedMerge) {\r\n                    additionalTextures.push(babylonMaterial.fuzzColorTexture);\r\n                }\r\n                if (fuzzTexturesNeedMerge) {\r\n                    const texId = GetFuzzColorTextureId(babylonMaterial);\r\n                    if (!this._cachedInternalTexturesMap[texId]) {\r\n                        const mergedInternalTexture = await CreateMergedFuzzInternalTexture(babylonMaterial);\r\n                        if (mergedInternalTexture) {\r\n                            this._cachedInternalTexturesMap[texId] = mergedInternalTexture;\r\n                        }\r\n                    }\r\n                    if (this._cachedInternalTexturesMap[texId]) {\r\n                        if (babylonMaterial.fuzzColorTexture) {\r\n                            this._mergedTexturesMap[babylonMaterial.fuzzColorTexture.uniqueId] = CreateTempTexture(\r\n                                this._cachedInternalTexturesMap[texId],\r\n                                babylonMaterial.fuzzColorTexture\r\n                            );\r\n                            additionalTextures.push(this._mergedTexturesMap[babylonMaterial.fuzzColorTexture.uniqueId]);\r\n                        }\r\n                        if (babylonMaterial.fuzzRoughnessTexture) {\r\n                            this._mergedTexturesMap[babylonMaterial.fuzzRoughnessTexture.uniqueId] = CreateTempTexture(\r\n                                this._cachedInternalTexturesMap[texId],\r\n                                babylonMaterial.fuzzRoughnessTexture\r\n                            );\r\n                            additionalTextures.push(this._mergedTexturesMap[babylonMaterial.fuzzRoughnessTexture.uniqueId]);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            return additionalTextures;\r\n        }\r\n\r\n        return [];\r\n    }\r\n\r\n    public async postExportMaterialAsync(context: string, node: IMaterial, babylonMaterial: Material): Promise<IMaterial> {\r\n        return await new Promise((resolve) => {\r\n            if (babylonMaterial instanceof OpenPBRMaterial) {\r\n                if (babylonMaterial.fuzzWeight == 0.0) {\r\n                    resolve(node);\r\n                    return;\r\n                }\r\n\r\n                this._wasUsed = true;\r\n\r\n                if (node.extensions == null) {\r\n                    node.extensions = {};\r\n                }\r\n                const fuzzInfo: IKHRMaterialsFuzz = {\r\n                    fuzzFactor: babylonMaterial.fuzzWeight,\r\n                    fuzzColorFactor: babylonMaterial.fuzzColor.asArray(),\r\n                    fuzzRoughnessFactor: babylonMaterial.fuzzRoughness,\r\n                };\r\n\r\n                if (babylonMaterial.fuzzWeightTexture) {\r\n                    fuzzInfo.fuzzTexture = this._exporter._materialExporter.getTextureInfo(babylonMaterial.fuzzWeightTexture) ?? undefined;\r\n                }\r\n\r\n                let fuzzColorTexture: Nullable<BaseTexture> = null;\r\n                if (babylonMaterial.fuzzColorTexture) {\r\n                    if (this._mergedTexturesMap[babylonMaterial.fuzzColorTexture.uniqueId]) {\r\n                        fuzzColorTexture = this._mergedTexturesMap[babylonMaterial.fuzzColorTexture.uniqueId];\r\n                    } else {\r\n                        fuzzColorTexture = babylonMaterial.fuzzColorTexture;\r\n                    }\r\n                    fuzzInfo.fuzzColorTexture = this._exporter._materialExporter.getTextureInfo(fuzzColorTexture) ?? undefined;\r\n                }\r\n\r\n                let fuzzRoughnessTexture: Nullable<BaseTexture> = null;\r\n                if (babylonMaterial.fuzzRoughnessTexture) {\r\n                    if (this._mergedTexturesMap[babylonMaterial.fuzzRoughnessTexture.uniqueId]) {\r\n                        fuzzRoughnessTexture = this._mergedTexturesMap[babylonMaterial.fuzzRoughnessTexture.uniqueId];\r\n                    } else {\r\n                        fuzzRoughnessTexture = babylonMaterial.fuzzRoughnessTexture;\r\n                    }\r\n                    fuzzInfo.fuzzRoughnessTexture = this._exporter._materialExporter.getTextureInfo(fuzzRoughnessTexture) ?? undefined;\r\n                }\r\n\r\n                if (fuzzInfo.fuzzColorTexture !== null || fuzzInfo.fuzzRoughnessTexture !== null) {\r\n                    this._exporter._materialNeedsUVsSet.add(babylonMaterial);\r\n                }\r\n\r\n                node.extensions[NAME] = fuzzInfo;\r\n            }\r\n            resolve(node);\r\n        });\r\n    }\r\n}\r\n\r\nGLTFExporter.RegisterExtension(NAME, (exporter) => new KHR_materials_fuzz(exporter));\r\n"]}